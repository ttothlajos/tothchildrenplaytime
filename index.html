<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Toth Boys Game time score</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
    }
    h1 {
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 20px;
      min-width: 600px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #3498db;
      color: white;
    }
    input[type="text"], input[type="password"] {
      padding: 8px;
      width: 250px;
      margin: 5px 5px 10px 0;
    }
    button {
      padding: 6px 10px;
      background: #27ae60;
      color: white;
      border: none;
      cursor: pointer;
      margin: 5px 3px;
    }
    button:hover {
      background: #219150;
    }
    .highlight {
      background-color: #b6fcb6 !important;
    }
    .scroll-container {
      overflow-x: auto;
    }
    canvas {
      margin-top: 30px;
      max-width: 100%;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        font-size: 14px;
        padding: 6px;
      }
    
      button {
        padding: 4px 6px;
        font-size: 12px;
      }
    
      input[type="text"], input[type="password"] {
        width: 100%;
        max-width: 100%;
      }
    
      body {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <h1>Toth Boys Game time score</h1>

  <div>
    <input type="password" id="editPassword" placeholder="Írd be a jelszót a szerkesztéshez" />
    <button onclick="unlockEdit()">Szerkesztés engedélyezése</button>
  </div>

  <div>
    <input type="text" id="newCategoryInput" placeholder="Új kategória pl: Kukamosás+15 perc" />
    <button onclick="addCategory()">Hozzáadás</button>
    <button onclick="exportToCSV()">Exportálás Excelbe</button>
  </div>

  <div>
    <input type="password" id="resetPassword" placeholder="Pontok törlése jelszóval" />
    <button onclick="resetScores()">Pontok törlése</button>
  </div>

  <div class="scroll-container">
    <table id="scoreTable">
      <thead>
        <tr>
          <th>Category</th>
          <th>Time</th>
          <th>Abel</th>
          <th>Aron</th>
          <th>Lia</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <canvas id="scoreChart" width="400" height="200"></canvas>

<script>
  const backendUrl = "https://script.google.com/macros/s/AKfycbwYZvZLPYZ_IY0e4XoKq0kTc4botO5hUo4R-a191Qft_9QFYbm0ORDwveB4xckx0s22/exec";
  const editPass = 'admin123';
  let editEnabled = false;
  let data = [];

  const tableBody = document.getElementById('tableBody');

  async function loadData() {
    try {
      const response = await fetch(backendUrl);
      const json = await response.json();
      data = json.map(row => ({
        Category: row.Category || '',
        Time: row.Time || '',
        Abel: Number(row.Abel) || 0,
        Aron: Number(row.Aron) || 0,
        Lia: Number(row.Lia) || 0
      }));
      renderTable();
    } catch (e) {
      alert("Hiba az adatok betöltésekor: " + e.message);
    }
  }

  async function saveData() {
    try {
      await fetch(backendUrl, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
    } catch (e) {
      alert("Hiba a mentéskor: " + e.message);
    }
  }

  function renderTable() {
    tableBody.innerHTML = '';

    let total = { abel: 0, aron: 0, lia: 0 };
    data.forEach(row => {
      total.abel += row.Abel;
      total.aron += row.Aron;
      total.lia += row.Lia;
    });

    const maxPoints = Math.max(total.abel, total.aron, total.lia);

    data.forEach((row, index) => {
      const tr = document.createElement('tr');

      const createCell = (value, name) => {
        const cell = document.createElement('td');
        if (getTotal(name) === maxPoints && maxPoints > 0) {
          cell.classList.add('highlight');
        }
        let controls = '';
        if (editEnabled) {
          controls = `
            <button onclick="increment(${index}, '${name}')">+</button>
            <button onclick="decrement(${index}, '${name}')">−</button>
          `;
        }
        cell.innerHTML = `${value} ${controls}`;
        return cell;
      };

      const tdCat = document.createElement('td');
      tdCat.textContent = row.Category;
      tr.appendChild(tdCat);

      const tdTime = document.createElement('td');
      tdTime.textContent = row.Time;
      tr.appendChild(tdTime);

      tr.appendChild(createCell(row.Abel, 'abel'));
      tr.appendChild(createCell(row.Aron, 'aron'));
      tr.appendChild(createCell(row.Lia, 'lia'));

      tableBody.appendChild(tr);
    });

    drawChart();
  }

  function getTotal(name) {
    return data.reduce((sum, row) => sum + Number(row[capitalizeName(name)]), 0);
  }

  function capitalizeName(name) {
    return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  }

  async function increment(index, name) {
    if (!editEnabled) return;
    data[index][capitalizeName(name)]++;
    renderTable();
    await saveData();
  }

  async function decrement(index, name) {
    if (!editEnabled) return;
    if (data[index][capitalizeName(name)] > 0) {
      data[index][capitalizeName(name)]--;
      renderTable();
      await saveData();
    }
  }

  async function addCategory() {
    if (!editEnabled) {
      alert('Először add meg a helyes jelszót!');
      return;
    }
    const input = document.getElementById('newCategoryInput');
    const val = input.value.trim();
    if (!val.includes('+')) {
      alert('Hibás formátum! Pl.: Mosogatás+15 perc');
      return;
    }
    const [cat, time] = val.split('+');
    if (!cat || !time) {
      alert('Mindkét mező szükséges!');
      return;
    }
    data.push({
      Category: cat.trim(),
      Time: time.trim(),
      Abel: 0,
      Aron: 0,
      Lia: 0
    });
    input.value = '';
    renderTable();
    await saveData();
  }

  async function resetScores() {
    const pass = document.getElementById('resetPassword').value;
    if (pass !== editPass) {
      alert('Hibás jelszó!');
      return;
    }
    if (!confirm('Biztosan törlöd az összes pontot?')) return;
    data.forEach(row => {
      row.Abel = 0;
      row.Aron = 0;
      row.Lia = 0;
    });
    document.getElementById('resetPassword').value = '';
    renderTable();
    await saveData();
  }

  function unlockEdit() {
    const pw = document.getElementById('editPassword').value;
    if (pw === editPass) {
      editEnabled = true;
      alert('Szerkesztés engedélyezve.');
      renderTable();
    } else {
      alert('Hibás jelszó.');
    }
  }

  function exportToCSV() {
    let csv = 'Category,Time,Abel,Aron,Lia\n';
    data.forEach(row => {
      csv += `${row.Category},${row.Time},${row.Abel},${row.Aron},${row.Lia}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'toth_boys_score.csv';
    link.click();
  }

  function drawChart() {
    const canvas = document.getElementById('scoreChart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    ctx.clearRect(0, 0, width, height);

    const totals = {
      Abel: getTotal('abel'),
      Aron: getTotal('aron'),
      Lia: getTotal('lia'),
    };

    const names = Object.keys(totals);
    const max = Math.max(...Object.values(totals), 1);
    const barWidth = 80;
    const gap = 40;

    names.forEach((name, i) => {
      const x = 50 + i * (barWidth + gap);
      const barHeight = (totals[name] / max) * (height - 50);
      ctx.fillStyle = '#3498db';
      ctx.fillRect(x, height - barHeight - 30, barWidth, barHeight);
      ctx.fillStyle = '#000';
      ctx.textAlign = 'center';
      ctx.fillText(name, x + barWidth / 2, height - 10);
      ctx.fillText(totals[name], x + barWidth / 2, height - barHeight - 40);
    });
  }

  window.onload = loadData;
</script>

</body>
</html>
